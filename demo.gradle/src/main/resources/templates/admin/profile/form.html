<!DOCTYPE html>
<html
	lang="ko"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/layouts/layout}"
>
<head>

<link th:href="@{/libs/bootstrap-table-master/dist/bootstrap-table.min.css}" rel="stylesheet">
<link th:href="@{/libs/bootstrap-table-master/dist/extensions/reorder-rows/bootstrap-table-reorder-rows.css}" rel="stylesheet">

</head>

	<div layout:fragment="content" class="container-fluid p-0">

	<h1 class="h3 mb-3">Profile</h1>

	<div class="row">
		<div class="col-md-3 col-xl-2">

			<div class="card">
<!-- 				<div class="card-header">
					<h5 class="card-title mb-0">Profile Settings</h5>
				</div> -->

				<div class="list-group list-group-flush rounded-0" role="tablist">
					<a class="list-group-item list-group-item-action active" data-toggle="list" href="#profile-images" role="tab">
						Profile Images
				    </a>
					<a class="list-group-item list-group-item-action" data-toggle="list" href="#basic-profile" role="tab">
						Basic Profile
				    </a>
					<a class="list-group-item list-group-item-action" data-toggle="list" href="#status" role="tab">
						Status
				    </a>
					<a class="list-group-item list-group-item-action" data-toggle="list" href="#job-classes" role="tab">
						Job / Class
				    </a>
					<a class="list-group-item list-group-item-action" data-toggle="list" href="#main-quest-progress" role="tab">
						Main Quest Progress
				    </a>
					<a class="list-group-item list-group-item-action" data-toggle="list" href="#duty-progress" role="tab">
						Duty Progress
				    </a>
				</div>
			</div>
		</div>

		<div class="col-md-9 col-xl-10">
			<div class="tab-content">
				
				<div class="tab-pane fade show active" id="profile-images" role="tabpanel">
					<div class="card rounded-0">
						<div class="card-header">
							<h5 class="card-title mb-0">Profile Images</h5>
						</div>
						<div class="card-body">
							<form>
								<div class="row">
									<div class="mb-3">
										<label class="form-label w-100">File input</label>
										<input id="file" type="file" multiple="multiple">
										<small class="form-text text-muted">파일은 최대 5개까지 추가할 수 있습니다.</small>
									</div>
								</div>

								<!-- table -->
 								<table class="table table-sm mb-3"
								    id="table"
								  data-use-row-attr-func="true"
								  data-reorderable-rows="true"
								  data-height="280">
									<thead>
										<tr>
											<th scope="col" data-field="row_id" data-sortable="false" style="width:5%;">no</th>
											<th scope="col" data-field="filename" data-sortable="false" style="width:65%;">filename</th>
											<th scope="col" data-field="preview" data-sortable="false" style="width:25%">preview</th>
											<th scope="col" data-field="actions" data-sortable="false" data-formatter="editFormatter" style="width:5%">actions</th>
										</tr>
									</thead>
									<tbody>

									</tbody>
								</table>
								
								<div class="mt-3">
									<button type="submit" class="btn btn-primary">Save changes</button>
									<button type="submit" class="btn btn-success">Show Preview</button>
								</div>
							</form>

						</div>
					</div>				
				</div>

				<div class="tab-pane fade" id="basic-profile" role="tabpanel">

					<div class="card rounded-0">
						<div class="card-header">
							<h5 class="card-title mb-0">Basic Profile</h5>
						</div>
						<div class="card-body">
							<form>
								<div class="row row-cols-md-auto align-items-center mb-2">
									<div class="col-md-6">
										<label class="mb-2" for="inlineFormInputName2">Character Name</label>
											<input type="checkbox" class="form-check-input ml-2 " id="customControlInline">
											<label class="form-check-label" for="customControlInline">It's different from in-game name</label>
										<input type="text" class="form-control mb-2 mr-sm-2" placeholder="Somebody">
									</div>
									<div class="col-md-6">
										<label class="mb-2" for="inlineFormInputGroupUsername2">Entitle</label>
										<input type="text" class="form-control mb-2 mr-sm-2" placeholder="Guidance Angel">
									</div>
								</div>
<!-- 								<div class="row">
									<div class="col-md-8">
										<div class="mb-3">
											<label class="form-label" for="inputUsername">Biography</label>
											<textarea rows="2" class="form-control" id="inputBio" placeholder="Tell something about yourself"></textarea>
										</div>
									</div>
								</div> -->
								<div class="row">
									<div class="mb-3 col-md-4">
										<label class="form-label" for="city">City</label>
										<select name="city" class="form-control" data-code="city"></select>
									</div>
									<div class="mb-3 col-md-4">
										<label class="form-label" for="grandCompany">Grand Company</label>
										<select name="grandCompany" class="form-control" data-code="grand_company"></select>
									</div>
									<div class="mb-3 col-md-4">
										<label class="form-label" for="grandCompanyRank">Rank</label>
										<select name="grandCompanyRank" class="form-control" data-code="grand_company_rank"></select>
									</div>
								</div>	
								<div class="row">
									<div class="mb-3 col-md-2">
										<label class="form-label" for="birthMonth">BirthDay</label>
						              	<select name="birthMonth" class="form-control" data-code="birth_month"></select>
									</div>
									<div class="mb-3 col-md-2">
										<label class="form-label" for="birthDay">&nbsp;</label>
										<select id="birthDay" class="form-control col" data-code="birth_day"></select>
									</div>
									<div class="mb-3 col-md-2">
										<label class="form-label" for="theTwelve">The Twelve</label>
										<select name="theTwelve" class="form-control col" data-code="the_twelve"></select>
									</div>
								</div>

								<button type="submit" class="btn btn-primary">Save changes</button>
							</form>

						</div>
					</div>
				</div> <!-- #basic-profile -->
				
				<div class="tab-pane fade" id="status" role="tabpanel">
				
					<div class="card rounded-0">
						<div class="card-header">

							<h5 class="card-title mb-0">Status</h5>
						</div>
						<div class="card-body">
							<form>
								<div class="row">
									<div class="mb-3 col-md-6">
										<label class="form-label" for="hometownServer">Hometown Server</label>
										<select name="hometownServer" class="form-control" data-code="server_kr"></select>
									</div>
									<div class="mb-3 col-md-6">
										<label class="form-label" for="mainJob">Main Job</label>
										<select name="mainJob" class="form-control col" data-code="job">
<!-- 						                	<option selected>Choose...</option> -->
<!-- 						                	<optgroup label="Classes"> -->
<!-- 						                	<option>Archer</option> -->
<!-- 						                	<option>...</option> -->
<!-- 						                	</optgroup> -->
<!-- 						                	<optgroup label="Jobs"> -->
<!-- 						                	<option>Gunbreaker</option> -->
<!-- 						                	<option>Dancer</option> -->
<!-- 						                	</optgroup> -->
						              	</select>
									</div>

								</div>
								<div class="row">
									<div class="mb-3 col-md-6">
										<label class="form-label" for="bondingStatus">Eternal Bonding</label>
										<select id="bondingStatus" class="form-control" data-code="bonding_status">
							                <option selected>Choose...</option>
							                <option>Looking for a partner</option>
							                <option>I don't want a bonding now</option>
							                <option>...</option>
						              	</select>
									</div>
									<div class="mb-3 col-md-2">
										<label class="form-label" for="bondingPlan">Plan</label>
										<select id="bondingPlan" class="form-control col" data-code="bonding_plan">
							                <option selected>Choose...</option>
							                <option>Standard</option>
							                <option>Gold</option>
							                <option>Platinum</option>
						              	</select>
									</div>
									<div class="mb-3 col-md-4">
										<label class="form-label" for="bondingSheet">Bonding Sheet</label>
										<select id="bondingSheet" class="form-control col">
							                <option selected>Choose...</option>
							                <option>Sheet [2021. 04. 30]</option>
							                <option>Sheet [2021. 04. 01]</option>
						              	</select>
									</div>
								</div>
								<button type="submit" class="btn btn-primary">Save changes</button>
							</form>

						</div>
					</div>
					
				</div> <!-- #status -->
				
				<div class="tab-pane fade" id="job-classes" role="tabpanel">
					<div class="card rounded-0">
						<div class="card-header">
							<h5 class="card-title">Job / Class</h5>
							<!-- <h6 class="card-subtitle text-muted">Using the most basic table markup, here’s how .table-based tables look in Bootstrap.</h6> -->
						</div>
						<table class="table table-sm">
							<thead>
								<tr>
									<th style="width:50%;">Job / Class</th>
									<th style="width:50%">Level</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div> <!-- #job-classes -->
				
				<div class="tab-pane fade" id="main-quest-progress" role="tabpanel">
					<div class="card rounded-0">
						<div class="card-header">
							<h5 class="card-title">Main Quest Progress <img class="icon" th:src="@{/images/icons/duty/main_quests_available.png}"></h5>
							<!-- <h6 class="card-subtitle text-muted">Using the most basic table markup, here’s how .table-based tables look in Bootstrap.</h6> -->
						</div>
						<table class="table table-sm">
							<thead>
								<tr>
									<th style="width:30%;">Patch</th>
									<th style="width:30%;">Main Quest</th>
									<th>Progress</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>2.0</td>
									<td>Reborn Realm</td>
									<td>
										<select class="form-control col" data-code="progress"></select>
									</td>
								</tr>
								<tr>
									<td>3.0</td>
									<td>Heavensward</td>
									<td>
										<select class="form-control col" data-code="progress"></select>
									</td>
								</tr>
								<tr>
									<td>4.0</td>
									<td>Stormblood</td>
									<td>
										<select class="form-control col" data-code="progress"></select>
									</td>
								</tr>
								<tr>
								<td>5.0</td>
									<td>ShadowBringers</td>
									<td>
										<select class="form-control col" data-code="progress"></select>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div> <!-- #main-quest-progress -->
				
				<div class="tab-pane fade" id="duty-progress" role="tabpanel">
					<div class="card rounded-0">
						<div class="card-header">
							<h5 class="card-title">Duty Progress <img class="icon" th:src="@{/images/icons/duty/main_quests_available.png}"></h5>
							<!-- <h6 class="card-subtitle text-muted">Using the most basic table markup, here’s how .table-based tables look in Bootstrap.</h6> -->
						</div>
						<table class="table table-sm">
							<thead>
								<tr>
									<th style="width:50%;">Job / Class</th>
									<th style="width:50%">Progress</th>
<!-- 									<th class="d-none d-md-table-cell" style="width:25%">Date of Birth</th>
									<th>Actions</th> -->
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>Reborn Realm</td>
									<td>
										<select class="form-control col" data-code="progress"></select>
									</td>
								</tr>
								<tr>
									<td>Heavensward</td>
									<td>
										<select class="form-control col" data-code="progress"></select>
									</td>
								</tr>
								<tr>
									<td>Stormblood</td>
									<td>
										<select class="form-control col" data-code="progress"></select>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div> <!-- #duty-progress -->

			</div>
		</div>
	</div>

	<script
	  src="https://code.jquery.com/jquery-3.5.1.js"
	  integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
	  crossorigin="anonymous"></script>
	<script th:src="@{/libs/TableDnD-master/js/jquery.tablednd.js}"></script>
	<script th:src="@{/libs/bootstrap-table-master/dist/bootstrap-table.min.js}"></script>
	<script th:src="@{/libs/bootstrap-table-master/dist/extensions/reorder-rows/bootstrap-table-reorder-rows.min.js}"></script>  
	<script>
		$(function() {
			initJobClassTable();
			
			$table = $('#table');

	        var formData = new FormData();
			
			editFormatter = function(value, row, index) {
				var btn = '<a onclick="deleteRow(' + index + ');"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash align-middle"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></a>';
				return btn;
			}
			
			$table.bootstrapTable({
				onReorderRowsDrop: function (row) {
		        	sortRowOrder();
		        }
			});
			
			sortRowOrder = function() {
				var row_cnt = $table.bootstrapTable('getData').length;
				for (var i=0; i < row_cnt; i++) {
					$table.bootstrapTable('updateRow', {index: i, row: {'row_id' : i+1}});
				}
			}
			
			deleteRow = function(idx) {
				//console.log(idx);				
				var row_data = $table.bootstrapTable('getData')[idx];
				//console.log(row_data);
				//console.log(row_data['preview']);
				var imgObj = $.parseHTML(row_data['preview']);
				var target_id = $(imgObj).data('code');
				//console.log(target_id);

				deleteFormDataElement(target_id, formData);

				$table.bootstrapTable('remove', {
			        field: '$index',
			        values: [idx]
			    });
				
				sortRowOrder();
			}
			
			function deleteFormDataElement(target_id, formData) {
				console.log('============before delete============');
				console.log(formData);
				console.log('=====================================');
				
				var tempFormData = new FormData();
				
				for (var key of formData.keys()) {
				   if (key != target_id) {
					   tempFormData.append(key, formData[key]);
				   }
				}
				
				formData = tempFormData;
				
				console.log('============after delete============');
				console.log(formData);
				console.log('=====================================');
			}

			var fileList = new Object();

			$('#file').change(function(evt) {
				var imgObj;

			    if($('#file').files && $('#file').files[0]) {

			        const reader = new FileReader();
			        reader.onload = function(e){
			        	console.log(e.target.result);
			        	imgObj = e.target.result;
			        }

			        reader.readAsDataURL(input.files[0]);
			    }
				
				fileList = $(this)[0].files;

			    for(var i=0;i < fileList.length;i++){
			    	if (i >= 5) {
			    		alert('파일은 5개까지 추가할 수 있습니다.');
			    		break;
			    	} else {
			    		var file = fileList[i];
			    		console.log(file);
			    		
				        var temp_id = (new Date()).valueOf();
				        formData.append(temp_id, file);
				        addRow(temp_id , imgObj);	
			    	}

			    }
			    
		        console.log(formData);
			});

			addRow = function(temp_id, img) {
				var table_length = $("#table tr").length;
				var filename = 'image.jpg';
				var preview = '<img data-code="' + temp_id + '"class="list-img-thumb" src="' + img + '">';
	
				$table.bootstrapTable('insertRow', {
					index: table_length-1,
					row: {
						row_id: null,
						filename: filename,
						preview: preview,
						actions: null
					}
				});
				
				sortRowOrder();
			}

	  })
	  
		function initJobClassTable() {
			var $tbody = $('#job-classes table > tbody');
			
			console.log($tbody);
			
			
			$.ajax({
			    url: contextPath + '/json/code-class/items?codeClassId=job',
			    type: 'GET',
			    aysnc: false,
			    success: function(result) {
			    	var list = result.list;
			    	//console.log(list);
			    	
			    	var html = '';
			    	
			    	for (var i=0; i<list.length; i++) {
			    		
			    		html += '<tr>';
			    		html += '<td><img class="icon" src="' + contextPath + '/images/icons/job/' + list[i].codeVal +  '.png">' + list[i].codeNmEn + '</td>';
			    		html += '<td>' + 80 + '</td>';
			    		html += '</tr>';

			    	}

			    	$tbody.html(html);
			    },
			    error: function(error) {
			        //console.error(error);
			    }
			});

		}
	</script>
</div>
</html>